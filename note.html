<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>You Say It, We Sing It.</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://unpkg.com/pinyin-pro"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Open+Sans:wght@400;600&display=swap');

        body {
            font-family: 'Open Sans', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f0e68c, #add8e6); /* Soft gradient background */
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden; /* Prevent background items from creating scrollbars */
        }

        /* Artistic Background Elements (Books & Albums) */
        .background-item {
            position: absolute;
            opacity: 0.15;
            filter: blur(2px) grayscale(70%);
            transform: rotate(var(--rotate, 0deg)) scale(var(--scale, 1));
            transition: transform 0.5s ease-out; /* Smooth hover effect */
        }
        .background-item img {
            width: var(--size, 100px);
            height: var(--size, 150px);
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* --- Example Images for Background --- */
        .item-1 { top: 5%; left: 10%; --rotate: -15deg; --size: 120px; z-index: -1; }
        .item-2 { bottom: 10%; right: 5%; --rotate: 20deg; --size: 150px; z-index: -1; }
        .item-3 { top: 20%; right: 15%; --rotate: 5deg; --size: 90px; z-index: -1; }
        .item-4 { bottom: 25%; left: 8%; --rotate: -10deg; --size: 110px; z-index: -1; }
        .item-5 { top: 40%; left: 30%; --rotate: 30deg; --size: 80px; z-index: -1; }
        .item-6 { bottom: 5%; left: 40%; --rotate: -25deg; --size: 130px; z-index: -1; }

        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 25px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 800px;
            width: 90%;
            position: relative;
            z-index: 10; /* Ensure container is above background items */
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3.5em;
            color: #333;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        h2 {
            font-size: 1.2em;
            color: #666;
            margin-top: 0;
            margin-bottom: 30px;
            font-weight: 400;
        }

        textarea {
            width: calc(100% - 30px);
            height: 180px;
            margin: 20px 0;
            border-radius: 15px;
            border: 1px solid #ccc;
            padding: 15px;
            font-size: 1.1em;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        textarea:focus {
            border-color: #f7a700;
            box-shadow: 0 0 15px rgba(247, 167, 0, 0.2);
            outline: none;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
            align-items: center;
        }

        .control-group {
            text-align: left;
            padding: 0 10px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.95em;
        }

        select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #ccc;
            background-color: white;
            font-size: 1em;
            appearance: none; /* Remove default arrow */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
            cursor: pointer;
        }

        .slider-group {
            margin-top: 20px;
            text-align: left;
            padding: 0 10px;
        }

        input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            height: 8px;
            background: #ddd;
            border-radius: 5px;
            outline: none;
            margin-top: 5px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #f7a700;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        input[type="range"]::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #f7a700;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }

        button#playBtn {
            grid-column: 1 / -1; /* Make button span full width */
            padding: 15px 30px;
            font-size: 1.3em;
            background: linear-gradient(45deg, #f7a700, #ff5722);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(247, 167, 0, 0.3);
            transition: all 0.3s ease;
            font-weight: 700;
            margin-top: 20px;
        }
        button#playBtn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 25px rgba(247, 167, 0, 0.4);
        }

        #status {
            margin-top: 25px;
            font-size: 1em;
            color: #666;
            min-height: 20px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            h1 { font-size: 2.5em; }
            h2 { font-size: 1em; }
            .controls-grid { grid-template-columns: 1fr; }
            .control-group, .slider-group { text-align: center; }
            .background-item { display: none; /* Hide for smaller screens */ }
        }
    </style>
</head>
<body>

    <div class="background-item item-1">
        <img src="https://via.placeholder.com/120x180/ffd700/ffffff?text=Book+1" alt="Book Cover">
    </div>
    <div class="background-item item-2">
        <img src="https://via.placeholder.com/150x150/ff6347/ffffff?text=Album+2" alt="Album Cover">
    </div>
    <div class="background-item item-3">
        <img src="https://via.placeholder.com/90x130/87ceeb/ffffff?text=Book+3" alt="Book Cover">
    </div>
    <div class="background-item item-4">
        <img src="https://via.placeholder.com/110x160/98fb98/ffffff?text=Album+4" alt="Album Cover">
    </div>
    <div class="background-item item-5">
        <img src="https://via.placeholder.com/80x120/da70d6/ffffff?text=Book+5" alt="Book Cover">
    </div>
    <div class="background-item item-6">
        <img src="https://via.placeholder.com/130x130/ffa07a/ffffff?text=Album+6" alt="Album Cover">
    </div>

<div class="container">
    <h1>You Say It, We Sing It.</h1>
    <h2>Êîæ‰ªªÊÑè‰∏ÄÊÆµÊñáÂ≠óÔºåÊàë‰ª¨Â∞ÜÂÖ∂ËΩ¨Âåñ‰∏∫Áã¨ÁâπÁöÑÈü≥‰πêÊóãÂæã„ÄÇ</h2>
    
    <textarea id="textInput" placeholder="ËæìÂÖ•‰∏≠Êñá„ÄÅËã±ÊñáÊàñÊ∑∑ÂêàÊñáÂ≠ó..."></textarea>
    
    <div class="controls-grid">
        <div class="control-group">
            <label for="styleSelect">ÈÄâÊã©Èü≥‰πêÈ£éÊ†ºÔºö</label>
            <select id="styleSelect">
                <option value="techno">‚ö° Techno (Âº∫Âä≤ÁîµÂ≠ê)</option>
                <option value="old_school">üé§ Old School Hip Hop (Â§çÂè§ÈºìÁÇπ)</option>
                <option value="melody_pop">‚ú® Melody Pop (ÊµÅÁïÖÊóãÂæã)</option>
                <option value="free_jazz">üé∑ Free Jazz (Ëá™Áî±Âç≥ÂÖ¥)</option>
            </select>
        </div>
        <div class="slider-group">
            <label for="emotionSlider">Ë∞ÉËäÇÊÉÖÊÑüÂº∫Â∫¶Ôºö<span id="emotionValue">50% (‰∏≠ÊÄß)</span></label>
            <input type="range" id="emotionSlider" min="0" max="100" value="50">
        </div>
        <button id="playBtn" onclick="startMusic()">üéµ ÁîüÊàêÂπ∂Êí≠Êîæ</button>
    </div>
    
    <p id="status">ÂáÜÂ§áÂ∞±Áª™</p>
</div>

<script>
    const pentatonicScale = ["C4", "D4", "E4", "G4", "A4", "C5", "D5", "E5", "G5", "A5"];
    const chromaticScale = ["C4", "C#4", "D4", "D#4", "E4", "F4", "F#4", "G4", "G#4", "A4", "A#4", "B4", "C5"]; // Áî®‰∫éFree Jazz
    const { pinyin } = pinyinPro;
    let currentSynth = null; // Store current synth to dispose
    let currentDrumLoop = null; // Store drum loop to stop

    // Update emotion slider value display
    document.getElementById('emotionSlider').addEventListener('input', function() {
        let emotion = parseInt(this.value);
        let emotionText = "‰∏≠ÊÄß";
        if (emotion < 25) emotionText = "Âπ≥Èùô";
        else if (emotion < 50) emotionText = "ÊîæÊùæ";
        else if (emotion > 75) emotionText = "ÊøÄÂä®";
        else if (emotion > 50) emotionText = "Ê¥ªÂäõ";
        document.getElementById('emotionValue').textContent = `${emotion}% (${emotionText})`;
    });

    async function startMusic() {
        await Tone.start();
        const text = document.getElementById('textInput').value;
        const style = document.getElementById('styleSelect').value;
        const emotion = parseInt(document.getElementById('emotionSlider').value);
        const status = document.getElementById('status');

        if (!text.trim()) {
            alert("ËØ∑Èöè‰æøÂÜôÁÇπ‰ªÄ‰πàÂêßÔºÅ");
            return;
        }

        // Clean up previous instruments
        if (currentSynth) {
            currentSynth.dispose();
            currentSynth = null;
        }
        if (currentDrumLoop) {
            currentDrumLoop.dispose();
            currentDrumLoop = null;
        }
        Tone.Transport.stop();
        Tone.Transport.cancel();

        // Âü∫Á°ÄBPMÊ†πÊçÆÊÉÖÊÑüË∞ÉÊï¥
        let baseBPM = 100; // Default medium tempo
        if (emotion < 25) baseBPM = 80; // Calm
        else if (emotion < 50) baseBPM = 95; // Relaxed
        else if (emotion > 75) baseBPM = 140; // Excited
        else if (emotion > 50) baseBPM = 110; // Energetic
        
        let bpmMultiplier = 1;
        let noteDurationMultiplier = 0.12;
        let currentScale = pentatonicScale;

        // --- Style-specific instrument setup ---
        switch (style) {
            case 'techno':
                currentSynth = new Tone.MonoSynth({
                    oscillator: { type: "sawtooth" },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.1 },
                    filterEnvelope: { attack: 0.06, decay: 0.2, sustain: 0.5, release: 2, basePath: 200, octaves: 4 }
                }).toDestination();
                Tone.Transport.bpm.value = baseBPM * 1.2; // Faster for techno
                noteDurationMultiplier = 0.08;

                // Techno Kick Drum
                const technoKick = new Tone.MembraneSynth({
                    pitchDecay: 0.05, octave: 10, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 0.8 }
                }).toDestination();
                currentDrumLoop = new Tone.Loop(time => { technoKick.triggerAttackRelease("C1", "8n", time); }, "4n").start(0);
                break;

            case 'old_school':
                currentSynth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "square" }, // Bass-like square wave
                    envelope: { attack: 0.05, decay: 0.3, sustain: 0.7, release: 0.5 }
                }).toDestination();
                Tone.Transport.bpm.value = baseBPM * 0.9; // Slower, groovy tempo
                noteDurationMultiplier = 0.2;

                // Old School Beat (Kick, Snare, Hihat)
                const sampler = new Tone.Sampler({
                    urls: {
                        "C1": "https://tonejs.github.io/audio/salamander/kick.mp3",
                        "D1": "https://tonejs.github.io/audio/salamander/snare.mp3",
                        "E1": "https://tonejs.github.io/audio/salamander/hihat.mp3",
                    },
                    onload: () => {
                        currentDrumLoop = new Tone.Sequence((time, note) => {
                            sampler.triggerAttackRelease(note, "8n", time);
                        }, [
                            ["C1", ["E1", "E1"]], null, ["D1", ["E1", "E1"]], null
                        ], "4n").start(0);
                    }
                }).toDestination();
                break;

            case 'melody_pop':
                currentSynth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.05, decay: 0.5, sustain: 0.5, release: 0.8 },
                    volume: -8 // Softer
                }).toDestination();
                Tone.Transport.bpm.value = baseBPM * 1.1;
                noteDurationMultiplier = 0.15; // Moderate duration
                break;

            case 'free_jazz':
                currentSynth = new Tone.PolySynth(Tone.AMSynth, { // AM Synth for brighter, brassy sound
                    harmonicity: 2,
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0.3, release: 0.5 }
                }).toDestination();
                currentScale = chromaticScale; // Use full chromatic scale for more "free" notes
                Tone.Transport.bpm.value = baseBPM * (0.8 + Math.random() * 0.4); // Random tempo variation
                noteDurationMultiplier = 0.1 + Math.random() * 0.3; // Random durations
                break;
        }
        
        // --- Text Processing ---
        const pyResult = pinyin(text, { type: 'array' }); 
        let currentTime = 0;

        pyResult.forEach(pyWord => {
            let clean = pyWord.replace(/[^a-zA-Z]/g, "").toUpperCase();
            if (clean.length > 0) {
                let charCode = clean.charCodeAt(0) - 65; 
                // For Free Jazz, add some randomness to pitch
                let noteIndex = (charCode + (style === 'free_jazz' ? Math.floor(Math.random() * 7) - 3 : 0));
                let note = currentScale[Math.abs(noteIndex) % currentScale.length];
                
                let duration = clean.length * noteDurationMultiplier;
                // For Free Jazz, add randomness to duration
                if (style === 'free_jazz') {
                    duration *= (0.7 + Math.random() * 0.6);
                }

                Tone.Transport.schedule(time => {
                    currentSynth.triggerAttackRelease(note, duration, time);
                }, currentTime);

                currentTime += duration;
            }
        });

        status.innerText = `üéµ Ê≠£Âú®Êí≠Êîæ (${style}, ÊÉÖÊÑü ${emotion}%) ...`;
        Tone.Transport.start();
    }
</script>

</body>
</html>